<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeVault â€” Journal de Trading</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â—ˆ</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#050709;--bg2:#0a0d14;--bg3:#10141e;--bg4:#161c2a;--bg5:#1c2436;
  --border:#1a2138;--border2:#252e45;--border-glow:#00e29a18;
  --text:#eaf0fa;--text2:#7a8bb0;--text3:#4a5672;
  --green:#00e29a;--green2:#00c480;--green-dim:#00e29a08;--green-lo:#00e29a15;--green-mid:#00e29a30;--green-hi:#00e29a50;
  --red:#ff4466;--red-lo:#ff446615;--red-mid:#ff446630;
  --cyan:#38d6f4;--cyan-lo:#38d6f415;
  --purple:#9580ff;--purple-lo:#9580ff15;
  --amber:#ffb340;--amber-lo:#ffb34015;
  --font:'Sora',sans-serif;--mono:'JetBrains Mono',monospace;
  --radius:14px;--radius-sm:10px;--radius-xs:7px;
}
body{background:var(--bg);font-family:var(--font);color:var(--text);min-height:100vh;padding-top:110px;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.5}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::selection{background:var(--green-mid);color:var(--text)}

/* â•â•â• ANIMATIONS â•â•â• */
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideRight{from{opacity:0;transform:translateX(-30px)}to{opacity:1;transform:translateX(0)}}
@keyframes slideLeft{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes glow{0%,100%{box-shadow:0 0 20px var(--green-lo)}50%{box-shadow:0 0 40px var(--green-mid)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

.anim-up{animation:fadeUp .5s ease both}.anim-right{animation:slideRight .5s ease both}.anim-left{animation:slideLeft .5s ease both}.anim-scale{animation:scaleIn .4s ease both}.anim-fade{animation:fadeIn .4s ease both}
.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}.d4{animation-delay:.2s}.d5{animation-delay:.25s}.d6{animation-delay:.3s}.d7{animation-delay:.35s}.d8{animation-delay:.4s}.d9{animation-delay:.45s}.d10{animation-delay:.5s}

/* â•â•â• TOPBAR â•â•â• */
.topbar{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--bg)e8;backdrop-filter:blur(24px) saturate(1.4);-webkit-backdrop-filter:blur(24px) saturate(1.4);border-bottom:1px solid var(--border);padding:0 28px;height:66px;display:flex;align-items:center;justify-content:center}
.topbar-inner{max-width:1240px;width:100%;display:flex;align-items:center;justify-content:space-between;gap:14px}
.logo{display:flex;align-items:center;gap:14px;flex-shrink:0;cursor:default}
.logo svg{transition:transform .3s ease}.logo:hover svg{transform:rotate(-8deg) scale(1.08)}
.logo-text h1{font-size:17px;font-weight:800;letter-spacing:-.4px;background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-text span{font-size:9.5px;color:var(--text3);font-weight:500;letter-spacing:1.5px;text-transform:uppercase}

/* â•â•â• TABS â•â•â• */
.tabs{position:relative;display:flex;background:var(--bg3);border-radius:12px;padding:3px;border:1px solid var(--border);overflow:hidden}
.tabs .slider{position:absolute;top:3px;bottom:3px;border-radius:10px;background:var(--green);transition:left .4s cubic-bezier(.22,1,.36,1),width .4s cubic-bezier(.22,1,.36,1);z-index:0;box-shadow:0 2px 16px var(--green-mid)}
.tabs button{position:relative;z-index:1;padding:8px 18px;border-radius:10px;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:var(--font);transition:color .3s;background:transparent;color:var(--text2);white-space:nowrap}
.tabs button:hover{color:var(--text)}.tabs button.active{color:var(--bg)}

/* â•â•â• LAYOUT â•â•â• */
.app{max-width:1240px;margin:0 auto;padding:18px 28px 60px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px;transition:border-color .3s,box-shadow .3s}
.card:hover{border-color:var(--border2)}
.card h2{font-size:15px;font-weight:700;margin-bottom:4px;letter-spacing:-.2px;display:flex;align-items:center;gap:8px}
.card-desc{font-size:11px;color:var(--text3);margin:0 0 18px;line-height:1.6;padding-top:10px;border-top:1px solid var(--border)}
.card-glow{border-color:var(--green-mid);box-shadow:0 0 30px var(--green-dim),inset 0 1px 0 var(--green-lo)}
.row2{display:flex;gap:14px;flex-wrap:wrap}.row2>div{flex:1;min-width:290px}
.row3{display:flex;gap:14px;flex-wrap:wrap}.row3>div{flex:1;min-width:200px}

/* â•â•â• STATS â•â•â• */
.stat-row{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.stat{border-radius:var(--radius);padding:18px 22px;flex:1;min-width:145px;position:relative;overflow:hidden;transition:transform .25s ease,box-shadow .25s ease;cursor:default}
.stat:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,.3)}
.stat::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;filter:blur(40px);opacity:.12;pointer-events:none}
.stat-label{font-size:9.5px;color:var(--text3);text-transform:uppercase;letter-spacing:1.4px;font-weight:700;margin-bottom:8px}
.stat-value{font-size:28px;font-weight:800;font-family:var(--mono);letter-spacing:-1.5px;line-height:1}
.stat-sub{font-size:10.5px;margin-top:8px;font-weight:500;color:var(--text3)}

/* â•â•â• CHART â•â•â• */
.chart-box{position:relative;height:280px;margin-top:10px}
.chart-box.sm{height:220px}

/* â•â•â• TABLE â•â•â• */
.trade-table{width:100%;border-collapse:separate;border-spacing:0}
.trade-table th{text-align:left;font-size:9.5px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;padding:12px 14px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg2)}
.trade-table td{padding:11px 14px;font-size:12px;border-bottom:1px solid var(--border);font-family:var(--mono);font-weight:500;transition:background .15s}
.trade-table tr{transition:background .15s}.trade-table tr:hover td{background:var(--bg3)}
.dir-long{color:var(--green);font-weight:700}.dir-short{color:var(--red);font-weight:700}
.pnl-pos{color:var(--green);font-weight:700}.pnl-neg{color:var(--red);font-weight:700}
.tag{display:inline-block;padding:3px 10px;border-radius:var(--radius-xs);font-size:9.5px;font-weight:700;font-family:var(--font);letter-spacing:.3px;transition:transform .15s}
.tag:hover{transform:scale(1.06)}
.tag-crypto{background:var(--purple-lo);color:var(--purple)}.tag-forex{background:var(--cyan-lo);color:var(--cyan)}.tag-stock{background:var(--amber-lo);color:var(--amber)}

/* â•â•â• FORM â•â•â• */
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:14px;margin-bottom:18px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-group label{font-size:9.5px;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700}
.form-group input,.form-group select,.form-group textarea{padding:10px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-family:var(--mono);outline:none;transition:border-color .25s,box-shadow .25s,background .25s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--green);box-shadow:0 0 0 3px var(--green-lo);background:var(--bg2)}
.form-group select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%234a5672' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.form-group textarea{resize:vertical;min-height:70px;font-family:var(--font);font-size:12px;line-height:1.6}
.btn{padding:11px 26px;border-radius:var(--radius-sm);border:none;cursor:pointer;font-size:13px;font-weight:700;font-family:var(--font);transition:all .25s;position:relative;overflow:hidden}
.btn::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 40%,rgba(255,255,255,.08) 50%,transparent 60%);transform:translateX(-100%);transition:transform .5s}
.btn:hover::after{transform:translateX(100%)}
.btn-primary{background:linear-gradient(135deg,var(--green),var(--green2));color:var(--bg);box-shadow:0 4px 24px var(--green-mid)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 32px var(--green-hi)}
.btn-primary:active{transform:translateY(0)}
.btn-secondary{background:var(--bg3);color:var(--text2);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg4)}
.btn-danger{background:var(--red-lo);color:var(--red);border:1px solid var(--red-mid)}
.btn-danger:hover{background:var(--red-mid)}

/* â•â•â• CONFIDENCE DOTS â•â•â• */
.conf-dots{display:flex;gap:4px;align-items:center}
.conf-dot{width:10px;height:10px;border-radius:50%;border:2px solid var(--border);cursor:pointer;transition:all .2s}
.conf-dot:hover{border-color:var(--amber);transform:scale(1.2)}
.conf-dot.active{background:var(--amber);border-color:var(--amber);box-shadow:0 0 8px var(--amber-lo)}

/* â•â•â• STREAK BADGE â•â•â• */
.streak-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;font-family:var(--mono);animation:float 3s ease-in-out infinite}
.streak-win{background:var(--green-lo);color:var(--green);border:1px solid var(--green-mid)}
.streak-loss{background:var(--red-lo);color:var(--red);border:1px solid var(--red-mid)}

/* â•â•â• P&L CALENDAR â•â•â• */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.cal-header{font-size:9px;text-transform:uppercase;color:var(--text3);text-align:center;padding:6px;font-weight:700;letter-spacing:.8px}
.cal-day{aspect-ratio:1;border-radius:var(--radius-xs);display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;font-family:var(--mono);cursor:default;position:relative;min-height:40px;transition:transform .2s,box-shadow .2s}
.cal-day:hover{transform:scale(1.08);z-index:2;box-shadow:0 4px 20px rgba(0,0,0,.4)}
.cal-day .day-num{font-size:8.5px;color:var(--text3);margin-bottom:2px;font-weight:600}
.cal-day .day-pnl{font-weight:800;font-size:10px}
.cal-day .day-count{font-size:7px;color:var(--text3);margin-top:1px}

/* â•â•â• PERF BADGES â•â•â• */
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
.badge{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--bg3);transition:transform .2s,box-shadow .2s;cursor:default}
.badge:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.badge .badge-icon{font-size:16px}
.badge.earned{border-color:var(--amber);background:var(--amber-lo)}

/* â•â•â• MONTH PICKER â•â•â• */
.month-nav{display:flex;align-items:center;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.month-btn{width:36px;height:36px;border-radius:var(--radius-xs);border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-family:var(--font)}
.month-btn:hover{border-color:var(--green-mid);color:var(--green);background:var(--green-dim)}
.month-btn:active{transform:scale(.94)}
.month-btn.today-btn{font-size:11px;width:auto;padding:0 14px;font-weight:700;letter-spacing:.5px}
.month-label{font-size:15px;font-weight:800;font-family:var(--mono);min-width:180px;text-align:center;background:linear-gradient(135deg,var(--text),var(--text2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;cursor:default;user-select:none}
.month-pills{display:flex;gap:3px;flex-wrap:wrap}
.month-pill{padding:4px 10px;border-radius:var(--radius-xs);font-size:10px;font-weight:700;font-family:var(--mono);cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text3);transition:all .2s;text-transform:uppercase;letter-spacing:.5px}
.month-pill:hover{border-color:var(--border2);color:var(--text2)}
.month-pill.active{background:var(--green);color:var(--bg);border-color:var(--green)}
.month-pill.has-data{border-color:var(--green-mid);color:var(--text2)}
.month-summary{display:flex;gap:16px;align-items:center;margin-top:12px;padding:12px 16px;border-radius:var(--radius-sm);background:var(--bg3);font-family:var(--mono);font-size:12px;flex-wrap:wrap}

/* â•â•â• FILTERS â•â•â• */
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.fbtn{padding:6px 16px;border-radius:var(--radius-xs);font-size:11px;font-weight:700;cursor:pointer;border:1px solid transparent;font-family:var(--mono);transition:all .2s}
.fbtn:hover{transform:translateY(-1px)}

/* â•â•â• EMPTY â•â•â• */
.empty{text-align:center;padding:80px 20px;color:var(--text3)}.empty-icon{font-size:56px;margin-bottom:16px}.empty p{font-size:14px;margin-bottom:20px}

/* â•â•â• TODAY BANNER â•â•â• */
.today-banner{background:linear-gradient(135deg,var(--green-lo),var(--cyan-lo));border:1px solid var(--green-mid);border-radius:var(--radius);padding:16px 22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:16px}
.today-banner .tb-left{display:flex;align-items:center;gap:12px}
.today-banner .tb-dot{width:10px;height:10px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite}

/* â•â•â• TOOLTIP â•â•â• */
.tip{position:relative}.tip::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) scale(.9);background:var(--bg4);color:var(--text);padding:6px 12px;border-radius:var(--radius-xs);font-size:10px;font-family:var(--font);font-weight:500;white-space:nowrap;opacity:0;pointer-events:none;transition:all .2s;border:1px solid var(--border);z-index:50}
.tip:hover::after{opacity:1;transform:translateX(-50%) scale(1)}

/* â•â•â• ACCOUNT SWITCHER â•â•â• */
.acct-bar{display:flex;align-items:center;gap:6px;padding:10px 28px;background:var(--bg2)ee;backdrop-filter:blur(16px);border-bottom:1px solid var(--border);position:fixed;top:66px;left:0;right:0;z-index:99;justify-content:center}
.acct-bar-inner{max-width:1240px;width:100%;display:flex;align-items:center;gap:8px;overflow-x:auto;scrollbar-width:none}
.acct-bar-inner::-webkit-scrollbar{display:none}
.acct-bar-label{font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.4px;text-transform:uppercase;flex-shrink:0;margin-right:4px}
.acct-pill{padding:6px 16px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--bg3);color:var(--text2);transition:all .25s;white-space:nowrap;font-family:var(--font);display:flex;align-items:center;gap:6px}
.acct-pill:hover{border-color:var(--border2);transform:translateY(-1px)}
.acct-pill.active{background:var(--green);color:var(--bg);border-color:var(--green);box-shadow:0 2px 12px var(--green-mid)}
.acct-pill .acct-pnl{font-family:var(--mono);font-size:10px;opacity:.8}
.acct-add{padding:6px 14px;border-radius:20px;font-size:14px;font-weight:700;cursor:pointer;border:1px dashed var(--border);background:transparent;color:var(--text3);transition:all .25s;flex-shrink:0}
.acct-add:hover{border-color:var(--green-mid);color:var(--green)}
.acct-modal{position:fixed;inset:0;z-index:300;background:rgba(5,7,9,.85);backdrop-filter:blur(12px);display:flex;align-items:center;justify-content:center;animation:fadeIn .2s ease}
.acct-modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:28px;width:90%;max-width:420px;animation:scaleIn .3s ease}
.acct-modal-box h3{font-size:16px;font-weight:800;margin-bottom:16px}
.acct-color-picker{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.acct-color{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .2s}
.acct-color:hover{transform:scale(1.15)}.acct-color.active{border-color:var(--text);transform:scale(1.15)}

/* â•â•â• LOGIN SCREEN â•â•â• */
.login-screen{position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:32px;transition:opacity .5s,transform .5s}
.login-screen.hidden{opacity:0;pointer-events:none;transform:scale(1.05)}
.login-logo{display:flex;flex-direction:column;align-items:center;gap:16px}
.login-logo h1{font-size:30px;font-weight:800;background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-logo p{color:var(--text3);font-size:13px}
.google-btn{display:flex;align-items:center;gap:12px;padding:14px 32px;border-radius:14px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:15px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .25s}
.google-btn:hover{background:var(--bg3);border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.4)}
.google-btn svg{width:20px;height:20px}
.login-error{color:var(--red);font-size:12px;max-width:320px;text-align:center}

/* â•â•â• SYNC BADGE â•â•â• */
.sync{font-size:9px;padding:3px 10px;border-radius:8px;font-weight:700;transition:all .3s;font-family:var(--mono);letter-spacing:.3px}
.sync.saving{background:var(--amber-lo);color:var(--amber)}
.sync.saved{background:var(--green-lo);color:var(--green)}
.sync.error{background:var(--red-lo);color:var(--red)}

/* â•â•â• USER MENU â•â•â• */
.user-info{display:flex;align-items:center;gap:8px;flex-shrink:0}
.user-avatar{width:30px;height:30px;border-radius:50%;border:2px solid var(--green-mid);cursor:pointer;transition:transform .2s}
.user-avatar:hover{transform:scale(1.1)}
.logout-btn{padding:5px 10px;border-radius:var(--radius-xs);border:1px solid var(--border);background:transparent;color:var(--text3);font-size:10px;cursor:pointer;font-family:var(--font);font-weight:600;transition:all .2s}
.logout-btn:hover{border-color:var(--red-mid);color:var(--red)}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:680px){
  .topbar-inner{flex-direction:column;gap:8px}.topbar{height:auto;padding:12px 16px}body{padding-top:160px}
  .acct-bar{top:auto;position:relative;padding:8px 14px}
  .form-grid{grid-template-columns:1fr 1fr}.stat-row{flex-direction:column}
  .app{padding:12px 14px 50px}.row2>div{min-width:100%}
  .tabs button{padding:7px 12px;font-size:11px}
}
</style>
</head>
<body>

<!-- â•â•â• LOGIN SCREEN â•â•â• -->
<div class="login-screen" id="login-screen">
  <div class="login-logo">
    <svg width="64" height="64" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" rx="11" fill="url(#lg2)"/>
      <path d="M12 26L16 18L20 22L25 13L28 17" stroke="#050709" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="28" cy="17" r="2.5" fill="#050709"/>
      <rect x="10" y="28" width="20" height="2" rx="1" fill="#050709" opacity=".25"/>
      <defs><linearGradient id="lg2" x1="0" y1="0" x2="40" y2="40"><stop stop-color="#00e29a"/><stop offset="1" stop-color="#38d6f4"/></linearGradient></defs>
    </svg>
    <h1>TradeVault</h1>
    <p>Votre journal de trading personnel</p>
  </div>
  <button class="google-btn" onclick="googleLogin()">
    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
    Se connecter avec Google
  </button>
  <div id="login-error" class="login-error"></div>
</div>

<!-- â•â•â• AMBIENT GLOW â•â•â• -->
<div style="position:fixed;top:-200px;left:50%;transform:translateX(-50%);width:600px;height:400px;background:radial-gradient(ellipse,var(--green-lo) 0%,transparent 70%);pointer-events:none;z-index:-1;opacity:.5"></div>

<!-- â•â•â• TOPBAR â•â•â• -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="logo">
      <svg width="38" height="38" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="40" height="40" rx="11" fill="url(#lg)"/>
        <path d="M12 26L16 18L20 22L25 13L28 17" stroke="#050709" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="28" cy="17" r="2.5" fill="#050709"/>
        <rect x="10" y="28" width="20" height="2" rx="1" fill="#050709" opacity=".25"/>
        <defs><linearGradient id="lg" x1="0" y1="0" x2="40" y2="40"><stop stop-color="#00e29a"/><stop offset="1" stop-color="#38d6f4"/></linearGradient></defs>
      </svg>
      <div class="logo-text"><h1>TradeVault</h1><span id="hdr-sub">chargementâ€¦</span></div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="tabs" id="tab-bar">
        <div class="slider" id="tab-slider"></div>
        <button id="tab-dashboard" onclick="sv('dashboard')">Dashboard</button>
        <button id="tab-log" onclick="sv('log')">Logger</button>
        <button id="tab-history" onclick="sv('history')">Historique</button>
        <button id="tab-insights" onclick="sv('insights')">Insights</button>
      </div>
      <span id="sync-badge" class="sync"></span>
      <div class="user-info" id="user-info" style="display:none">
        <img class="user-avatar" id="user-avatar" src="" alt="" title="Mon compte">
        <button class="logout-btn" onclick="doLogout()">DÃ©co</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• ACCOUNT BAR â•â•â• -->
<div class="acct-bar" id="acct-bar" style="display:none">
  <div class="acct-bar-inner" id="acct-bar-inner"></div>
</div>

<!-- â•â•â• ACCOUNT MODAL â•â•â• -->
<div class="acct-modal" id="acct-modal" style="display:none"></div>

<div class="app" id="app"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA & STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MK={crypto:{label:"Crypto",color:"#9580ff",tag:"tag-crypto",icon:"â—ˆ"},forex:{label:"Forex",color:"#38d6f4",tag:"tag-forex",icon:"â—"},stock:{label:"Actions",color:"#ffb340",tag:"tag-stock",icon:"â—‰"}};
const PAIRS={crypto:["BTC/USDT","ETH/USDT","SOL/USDT","BNB/USDT","XRP/USDT","DOGE/USDT","Autre"],forex:["EUR/USD","GBP/USD","USD/JPY","EUR/GBP","GBP/JPY","XAU/USD","USD/CHF","Autre"],stock:["SP500","NASDAQ","CAC40","DAX","AAPL","TSLA","NVDA","Autre"]};

const DEMO=[
  {id:1,date:"2026-02-02",market:"crypto",pair:"BTC/USDT",direction:"long",entry:96800,exit:97650,size:0.06,pnl:51,fees:2.10,confidence:3,notes:"Test premier trade. Breakout timide sur H1.",tags:["breakout"]},
  {id:2,date:"2026-02-03",market:"crypto",pair:"BTC/USDT",direction:"long",entry:97250,exit:98800,size:0.05,pnl:77.50,fees:2.10,confidence:4,notes:"Breakout H4 au-dessus rÃ©sistance 97k. Bonne patience.",tags:["breakout","trend"]},
  {id:3,date:"2026-02-03",market:"forex",pair:"EUR/USD",direction:"short",entry:1.0385,exit:1.0342,size:50000,pnl:215,fees:3.50,confidence:5,notes:"Rejet zone supply D1 + divergence RSI. Setup A+.",tags:["supply-demand"]},
  {id:4,date:"2026-02-04",market:"crypto",pair:"ETH/USDT",direction:"long",entry:2780,exit:2720,size:0.5,pnl:-30,fees:1.80,confidence:2,notes:"Stop touchÃ©. EntrÃ©e trop tÃ´t, pas attendu la confirmation.",tags:["impatience"]},
  {id:5,date:"2026-02-04",market:"crypto",pair:"SOL/USDT",direction:"long",entry:195.5,exit:208.3,size:10,pnl:128,fees:2.40,confidence:4,notes:"Suivi de tendance M15. TrÃ¨s bon R:R.",tags:["trend"]},
  {id:6,date:"2026-02-05",market:"forex",pair:"GBP/USD",direction:"long",entry:1.2510,exit:1.2485,size:30000,pnl:-75,fees:2.80,confidence:2,notes:"Faux signal, marchÃ© en range. Pas de momentum.",tags:["range"]},
  {id:7,date:"2026-02-05",market:"stock",pair:"SP500",direction:"long",entry:6025,exit:6078,size:2,pnl:106,fees:4.20,confidence:4,notes:"Rebond support oblique + gap ouverture.",tags:["gap"]},
  {id:8,date:"2026-02-06",market:"crypto",pair:"BTC/USDT",direction:"short",entry:99100,exit:97650,size:0.04,pnl:58,fees:1.90,confidence:5,notes:"Double top H1. Setup parfait.",tags:["reversal"]},
  {id:9,date:"2026-02-06",market:"crypto",pair:"BTC/USDT",direction:"long",entry:97600,exit:98200,size:0.06,pnl:36,fees:2.30,confidence:3,notes:"Scalp rapide sur rebond.",tags:["scalp"]},
  {id:10,date:"2026-02-07",market:"forex",pair:"USD/JPY",direction:"short",entry:154.80,exit:153.95,size:40000,pnl:220,fees:3.10,confidence:5,notes:"Yen fort, donnÃ©es macro favorables. Conviction haute.",tags:["macro","trend"]},
  {id:11,date:"2026-02-07",market:"crypto",pair:"ETH/USDT",direction:"long",entry:2740,exit:2830,size:0.8,pnl:72,fees:2.50,confidence:4,notes:"Accumulation Wyckoff. Spring confirmÃ©.",tags:["wyckoff"]},
  {id:12,date:"2026-02-08",market:"stock",pair:"NASDAQ",direction:"long",entry:17850,exit:17720,size:1,pnl:-130,fees:5.00,confidence:2,notes:"Sell-off inattendu. Stop trop large.",tags:["discipline"]},
  {id:13,date:"2026-02-08",market:"crypto",pair:"SOL/USDT",direction:"long",entry:202,exit:211.5,size:8,pnl:76,fees:2.10,confidence:4,notes:"Continuation haussiÃ¨re aprÃ¨s consolidation.",tags:["trend"]},
  {id:14,date:"2026-02-09",market:"forex",pair:"EUR/USD",direction:"long",entry:1.0355,exit:1.0410,size:60000,pnl:330,fees:4.00,confidence:5,notes:"Retournement weekly + NFP favorable.",tags:["macro","reversal"]},
  {id:15,date:"2026-02-09",market:"crypto",pair:"BTC/USDT",direction:"long",entry:98400,exit:101200,size:0.08,pnl:224,fees:3.50,confidence:5,notes:"Breakout range 4 jours. Gros mouvement.",tags:["breakout"]},
  {id:16,date:"2026-02-10",market:"crypto",pair:"ETH/USDT",direction:"short",entry:2870,exit:2895,size:0.6,pnl:-15,fees:1.80,confidence:1,notes:"Contre-tendance, mauvaise idÃ©e. Ã€ ne plus faire.",tags:["counter-trend"]},
  {id:17,date:"2026-02-10",market:"forex",pair:"GBP/JPY",direction:"long",entry:192.40,exit:193.85,size:20000,pnl:190,fees:3.20,confidence:4,notes:"Tendance forte, pullback sur EMA 20.",tags:["trend","ema"]},
];

const ACCT_COLORS=["#00e29a","#38d6f4","#9580ff","#ffb340","#ff4466","#f472b6","#4ade80","#facc15"];
const ACCT_ICONS=["ğŸ’°","ğŸ“Š","ğŸ¦","ğŸ¯","âš¡","ğŸ”¥","ğŸ’","ğŸš€"];

let S={
  accounts:[],  // [{id,name,color,icon,capital,trades:[],nextId}]
  activeAcct:null, // account id
  view:"dashboard",filter:"all",editId:null,deleteId:null,
  f:{date:ti(),market:"crypto",pair:"BTC/USDT",direction:"long",entry:"",exit:"",size:"",pnl:"",fees:"",confidence:3,notes:"",tags:""},
  calYear:new Date().getFullYear(),calMonth:new Date().getMonth(),
  modal:null // null | 'create' | 'edit' | 'delete'
};

// Helper to get current account
function CA(){return S.accounts.find(a=>a.id===S.activeAcct)||null}
// Helper to get current trades
Object.defineProperty(S,'trades',{get(){const a=CA();return a?a.trades:[]},set(v){const a=CA();if(a)a.trades=v}});
Object.defineProperty(S,'nextId',{get(){const a=CA();return a?a.nextId:1},set(v){const a=CA();if(a)a.nextId=v}});
Object.defineProperty(S,'capital',{get(){const a=CA();return a?a.capital:10000},set(v){const a=CA();if(a)a.capital=v}});

function ti(){return new Date().toISOString().slice(0,10)}
const fmt=n=>n>=0?"+"+n.toFixed(2):n.toFixed(2);
const fC=n=>(n>=0?"+":"")+(Math.abs(n)>=1000?n.toFixed(0):n.toFixed(2));
const fd=d=>new Date(d+"T12:00:00").toLocaleDateString("fr-FR",{day:"numeric",month:"short"});
const fdl=d=>new Date(d+"T12:00:00").toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"});

let CH={};function dC(){Object.values(CH).forEach(c=>c.destroy());CH={}}
const CO={responsive:true,maintainAspectRatio:false,animation:{duration:500,easing:'easeOutQuart'},plugins:{legend:{labels:{color:'#7a8bb0',font:{size:11,family:"'JetBrains Mono'"},boxWidth:12,padding:16}},tooltip:{backgroundColor:'#161c2a',titleColor:'#eaf0fa',bodyColor:'#eaf0fa',borderColor:'#252e45',borderWidth:1,cornerRadius:12,padding:14,titleFont:{family:"'JetBrains Mono'",weight:'bold'},bodyFont:{family:"'JetBrains Mono'"}}},scales:{x:{ticks:{color:'#4a5672',font:{size:10,family:"'JetBrains Mono'"}},grid:{color:'#1a213818'}},y:{ticks:{color:'#4a5672',font:{size:10,family:"'JetBrains Mono'"}},grid:{color:'#1a2138'}}}};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”¥ FIREBASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
  apiKey: "AIzaSyDLb0Y5vVdTUczoWeqlgfM4McT5pBgEcSM",
  authDomain: "tradevault-ad2b7.firebaseapp.com",
  projectId: "tradevault-ad2b7",
  storageBucket: "tradevault-ad2b7.firebasestorage.app",
  messagingSenderId: "103021367368",
  appId: "1:103021367368:web:9eba3336f9bfb0e849c87d"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
db.enablePersistence().catch(()=>{});

let currentUser = null;
let userDocRef = null;

/* â•â•â• AUTH â•â•â• */
function googleLogin() {
  document.getElementById("login-error").textContent = "";
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    document.getElementById("login-error").textContent = "Erreur : " + err.message;
  });
}

function doLogout() {
  auth.signOut();
}

auth.onAuthStateChanged(async user => {
  const loginEl = document.getElementById("login-screen");
  const userEl = document.getElementById("user-info");
  const acctBar = document.getElementById("acct-bar");
  if (user) {
    currentUser = user;
    userDocRef = db.collection("users").doc(user.uid);
    document.getElementById("user-avatar").src = user.photoURL || "";
    document.getElementById("user-avatar").title = user.displayName || user.email;
    userEl.style.display = "flex";
    acctBar.style.display = "flex";
    loginEl.classList.add("hidden");
    await loadFromFirestore();
    R();
  } else {
    currentUser = null;
    userDocRef = null;
    userEl.style.display = "none";
    acctBar.style.display = "none";
    loginEl.classList.remove("hidden");
  }
});

/* â•â•â• SYNC â•â•â• */
function showSync(status, text) {
  const el = document.getElementById("sync-badge");
  if (!el) return;
  el.className = "sync " + status;
  el.textContent = text;
  if (status === "saved") setTimeout(() => { el.textContent = ""; el.className = "sync"; }, 2500);
}

let saveTimeout = null;
async function saveToFirestore() {
  if (!userDocRef) return;
  showSync("saving", "â³");
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    try {
      await userDocRef.set({
        accounts: S.accounts,
        activeAcct: S.activeAcct,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      showSync("saved", "â˜ï¸ âœ“");
    } catch (e) {
      console.error("Save error:", e);
      showSync("error", "âœ— Erreur");
    }
  }, 600);
}

async function loadFromFirestore() {
  if (!userDocRef) return;
  try {
    const doc = await userDocRef.get();
    if (doc.exists) {
      const d = doc.data();
      S.accounts = d.accounts || [];
      S.activeAcct = d.activeAcct || (S.accounts.length ? S.accounts[0].id : null);
    }
    if (!S.accounts.length) {
      // Premier login: creer un compte demo
      const demoAcct = {
        id: 'acct_' + Date.now(),
        name: 'Compte Demo',
        color: ACCT_COLORS[0],
        icon: ACCT_ICONS[0],
        capital: 10000,
        nextId: DEMO.length + 1,
        trades: JSON.parse(JSON.stringify(DEMO))
      };
      S.accounts = [demoAcct];
      S.activeAcct = demoAcct.id;
      await saveToFirestore();
    }
  } catch (e) {
    console.error("Load error:", e);
    showSync("error", "âœ— Chargement");
  }
}

function persist() { saveToFirestore(); }

/* â•â•â• ACCOUNT MANAGEMENT â•â•â• */
function switchAcct(id) {
  S.activeAcct = id;
  S.filter = "all";
  S.editId = null;
  S.deleteId = null;
  persist();
  R();
}

function showAcctModal(type, acctId) {
  S.modal = type;
  S._editAcctId = acctId || null;
  renderModal();
}

function closeModal() {
  S.modal = null;
  S._editAcctId = null;
  document.getElementById("acct-modal").style.display = "none";
}

function renderModal() {
  const modal = document.getElementById("acct-modal");
  if (!S.modal) { modal.style.display = "none"; return; }
  modal.style.display = "flex";

  if (S.modal === 'create' || S.modal === 'edit') {
    const isEdit = S.modal === 'edit';
    const acct = isEdit ? S.accounts.find(a => a.id === S._editAcctId) : null;
    const name = acct ? acct.name : '';
    const capital = acct ? acct.capital : 10000;
    const color = acct ? acct.color : ACCT_COLORS[S.accounts.length % ACCT_COLORS.length];
    const icon = acct ? acct.icon : ACCT_ICONS[S.accounts.length % ACCT_ICONS.length];

    modal.innerHTML = `<div class="acct-modal-box anim-scale">
      <h3>${isEdit ? 'âœï¸ Modifier le compte' : 'â• Nouveau compte'}</h3>
      <div class="form-group" style="margin-bottom:14px"><label>Nom du compte</label><input type="text" id="acct-name" value="${name}" placeholder="Ex: Prop Firm FTMO, Compte Demo..." style="width:100%"></div>
      <div class="form-group" style="margin-bottom:14px"><label>Capital initial (â‚¬)</label><input type="number" id="acct-capital" value="${capital}" style="width:120px"></div>
      <div class="form-group" style="margin-bottom:14px"><label>Icone</label><div class="acct-color-picker" id="icon-picker">${ACCT_ICONS.map(ic => `<div class="acct-color ${ic === icon ? 'active' : ''}" onclick="pickIcon(this,'${ic}')" style="background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:16px;border-color:${ic === icon ? 'var(--text)' : 'var(--border)'}">${ic}</div>`).join('')}</div></div>
      <div class="form-group" style="margin-bottom:18px"><label>Couleur</label><div class="acct-color-picker" id="color-picker">${ACCT_COLORS.map(c => `<div class="acct-color ${c === color ? 'active' : ''}" onclick="pickColor(this,'${c}')" style="background:${c};border-color:${c === color ? 'var(--text)' : 'transparent'}"></div>`).join('')}</div></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="saveAcct(${isEdit ? "'" + S._editAcctId + "'" : 'null'})">${isEdit ? 'Sauvegarder' : 'Creer le compte'}</button>
        <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
        ${isEdit && S.accounts.length > 1 ? `<button class="btn btn-danger" onclick="showAcctModal('delete','${S._editAcctId}')" style="margin-left:auto">Supprimer</button>` : ''}
      </div>
    </div>`;
  } else if (S.modal === 'delete') {
    const acct = S.accounts.find(a => a.id === S._editAcctId);
    modal.innerHTML = `<div class="acct-modal-box anim-scale">
      <h3>ğŸ—‘ Supprimer "${acct ? acct.name : ''}" ?</h3>
      <p style="color:var(--text2);font-size:13px;margin:12px 0 20px;line-height:1.6">Tous les trades de ce compte seront supprimÃ©s dÃ©finitivement. Cette action est irrÃ©versible.</p>
      <div style="display:flex;gap:10px">
        <button class="btn btn-danger" onclick="deleteAcct('${S._editAcctId}')">Oui, supprimer</button>
        <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      </div>
    </div>`;
  }
}

let _pickedColor = null, _pickedIcon = null;
function pickColor(el, c) {
  _pickedColor = c;
  document.querySelectorAll('#color-picker .acct-color').forEach(e => { e.classList.remove('active'); e.style.borderColor = 'transparent'; });
  el.classList.add('active'); el.style.borderColor = 'var(--text)';
}
function pickIcon(el, ic) {
  _pickedIcon = ic;
  document.querySelectorAll('#icon-picker .acct-color').forEach(e => { e.classList.remove('active'); e.style.borderColor = 'var(--border)'; });
  el.classList.add('active'); el.style.borderColor = 'var(--text)';
}

function saveAcct(editId) {
  const name = document.getElementById('acct-name').value.trim();
  if (!name) return;
  const capital = parseFloat(document.getElementById('acct-capital').value) || 10000;
  const color = _pickedColor || ACCT_COLORS[S.accounts.length % ACCT_COLORS.length];
  const icon = _pickedIcon || ACCT_ICONS[S.accounts.length % ACCT_ICONS.length];

  if (editId) {
    S.accounts = S.accounts.map(a => a.id === editId ? { ...a, name, capital, color, icon } : a);
  } else {
    const newAcct = { id: 'acct_' + Date.now(), name, color, icon, capital, nextId: 1, trades: [] };
    S.accounts.push(newAcct);
    S.activeAcct = newAcct.id;
  }
  _pickedColor = null; _pickedIcon = null;
  persist(); closeModal(); R();
}

function deleteAcct(id) {
  S.accounts = S.accounts.filter(a => a.id !== id);
  if (S.activeAcct === id) S.activeAcct = S.accounts.length ? S.accounts[0].id : null;
  persist(); closeModal(); R();
}

function renderAcctBar() {
  const bar = document.getElementById("acct-bar-inner");
  if (!bar || !currentUser) return;
  let h = '<span class="acct-bar-label">Compte</span>';
  S.accounts.forEach(a => {
    const st = getStats(a.trades);
    const isActive = a.id === S.activeAcct;
    h += `<button class="acct-pill ${isActive ? 'active' : ''}" onclick="switchAcct('${a.id}')" ondblclick="showAcctModal('edit','${a.id}')" title="Double-clic pour modifier" style="${isActive ? `background:${a.color};border-color:${a.color};box-shadow:0 2px 12px ${a.color}40` : `border-color:${a.color}40`}">
      <span>${a.icon} ${a.name}</span>
      <span class="acct-pnl" style="color:${isActive ? 'inherit' : (st.netPnl >= 0 ? 'var(--green)' : 'var(--red)')}">${a.trades.length ? fC(st.netPnl) + 'â‚¬' : 'â€”'}</span>
    </button>`;
  });
  h += `<button class="acct-add" onclick="showAcctModal('create')" title="Nouveau compte">+</button>`;
  bar.innerHTML = h;
}

/* â•â•â• TAB SLIDER â•â•â• */
function updateSlider(){
  const bar=document.getElementById("tab-bar"),active=document.getElementById("tab-"+S.view),slider=document.getElementById("tab-slider");
  if(!bar||!active||!slider)return;
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  active.classList.add("active");
  const br=bar.getBoundingClientRect(),ar=active.getBoundingClientRect();
  slider.style.left=(ar.left-br.left)+"px";slider.style.width=ar.width+"px";
}

/* â•â•â• STATS ENGINE â•â•â• */
function getStats(trades){
  if(!trades.length)return{total:0,wins:0,losses:0,winRate:0,totalPnl:0,totalFees:0,netPnl:0,avgWin:0,avgLoss:0,profitFactor:0,bestTrade:0,worstTrade:0,maxWinStreak:0,maxLossStreak:0,currentStreak:0,avgConf:0,highConfWR:0};
  const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<=0);
  const totalPnl=trades.reduce((s,t)=>s+t.pnl,0);
  const totalFees=trades.reduce((s,t)=>s+(t.fees||0),0);
  const grossWins=wins.reduce((s,t)=>s+t.pnl,0);
  const grossLosses=Math.abs(losses.reduce((s,t)=>s+t.pnl,0));
  let ws=0,ls=0,mws=0,mls=0,cs=0;
  const sorted=[...trades].sort((a,b)=>a.date.localeCompare(b.date)||a.id-b.id);
  sorted.forEach(t=>{if(t.pnl>0){ws++;ls=0;cs=ws}else{ls++;ws=0;cs=-ls}if(ws>mws)mws=ws;if(ls>mls)mls=ls});
  const confTrades=trades.filter(t=>t.confidence>=4);
  const highConfWins=confTrades.filter(t=>t.pnl>0).length;
  return{total:trades.length,wins:wins.length,losses:losses.length,winRate:trades.length?(wins.length/trades.length*100):0,totalPnl,totalFees,netPnl:totalPnl-totalFees,avgWin:wins.length?grossWins/wins.length:0,avgLoss:losses.length?grossLosses/losses.length:0,profitFactor:grossLosses>0?(grossWins/grossLosses):grossWins>0?999:0,bestTrade:Math.max(...trades.map(t=>t.pnl)),worstTrade:Math.min(...trades.map(t=>t.pnl)),maxWinStreak:mws,maxLossStreak:mls,currentStreak:cs,avgConf:trades.reduce((s,t)=>s+(t.confidence||3),0)/trades.length,highConfWR:confTrades.length?(highConfWins/confTrades.length*100):0};
}

function ft(){return S.filter==="all"?S.trades:S.trades.filter(t=>t.market===S.filter)}
function getDailyPnl(trades){
  const map={};trades.forEach(t=>{if(!map[t.date])map[t.date]={pnl:0,fees:0,count:0};map[t.date].pnl+=t.pnl;map[t.date].fees+=(t.fees||0);map[t.date].count++});
  return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).map(([date,v])=>({date,...v,net:v.pnl-v.fees}));
}

/* â•â•â• RENDER â•â•â• */
function R(){
  if(!currentUser)return;
  dC();
  renderAcctBar();
  const acct=CA();
  if(!acct){
    document.getElementById("hdr-sub").textContent="Aucun compte";
    document.getElementById("app").innerHTML=`<div class="empty anim-scale"><div class="empty-icon">ğŸ“‚</div><p>CrÃ©ez votre premier compte pour commencer.</p><button class="btn btn-primary" onclick="showAcctModal('create')">+ Nouveau compte</button></div>`;
    return;
  }
  const tr=S.trades,st=getStats(tr);
  document.getElementById("hdr-sub").textContent=`${acct.icon} ${acct.name} Â· ${tr.length} trades Â· ${fC(st.netPnl)}â‚¬`;
  const app=document.getElementById("app");
  if(S.view==="dashboard")app.innerHTML=rDash();
  else if(S.view==="log")app.innerHTML=rLog();
  else if(S.view==="history")app.innerHTML=rHist();
  else app.innerHTML=rInsights();
  requestAnimationFrame(()=>{updateSlider();if(S.view==="dashboard")initCharts()});
}
function sv(v){S.view=v;R()}
function sf(f){S.filter=f;R()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rDash(){
  const trades=ft(),st=getStats(trades);
  if(!trades.length)return`<div class="empty anim-scale"><div class="empty-icon">â—ˆ</div><p>Aucun trade enregistrÃ©.</p><button class="btn btn-primary" onclick="sv('log')">Logger mon premier trade â†’</button></div>`;

  let h=renderFilters();

  // Current streak
  if(st.currentStreak!==0){
    const isWin=st.currentStreak>0;
    h+=`<div class="anim-up d1" style="margin-bottom:14px"><div class="streak-badge ${isWin?'streak-win':'streak-loss'}">${isWin?'ğŸ”¥':'â„ï¸'} SÃ©rie en cours : ${Math.abs(st.currentStreak)} ${isWin?'win':'loss'}${Math.abs(st.currentStreak)>1?'s':''}</div></div>`;
  }

  // Stats row 1 - Main
  h+=`<div class="stat-row anim-up d2">`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid ${st.netPnl>=0?'var(--green-mid)':'var(--red-mid)'}"><div class="stat-label">P&L Net</div><div class="stat-value" style="color:${st.netPnl>=0?'var(--green)':'var(--red)'}">${fC(st.netPnl)}<span style="font-size:14px;opacity:.5">â‚¬</span></div><div class="stat-sub">Brut: ${fC(st.totalPnl)}â‚¬ Â· Frais: -${st.totalFees.toFixed(0)}â‚¬</div></div>`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid var(--border)"><div class="stat-label">Win Rate</div><div class="stat-value" style="color:var(--cyan)">${st.winRate.toFixed(1)}<span style="font-size:14px;opacity:.5">%</span></div><div class="stat-sub">${st.wins}W Â· ${st.losses}L Â· ${st.total} trades</div></div>`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid var(--border)"><div class="stat-label">Profit Factor</div><div class="stat-value" style="color:${st.profitFactor>=1.5?'var(--green)':st.profitFactor>=1?'var(--amber)':'var(--red)'}">${st.profitFactor>=999?'âˆ':st.profitFactor.toFixed(2)}</div><div class="stat-sub">Moy W: +${st.avgWin.toFixed(0)}â‚¬ Â· Moy L: -${st.avgLoss.toFixed(0)}â‚¬</div></div>`;
  h+=`</div>`;

  // Stats row 2
  h+=`<div class="stat-row anim-up d3">`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid var(--green-mid)"><div class="stat-label">âš¡ Best</div><div class="stat-value pnl-pos" style="font-size:22px">${fC(st.bestTrade)}â‚¬</div></div>`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid var(--red-mid)"><div class="stat-label">ğŸ’€ Worst</div><div class="stat-value pnl-neg" style="font-size:22px">${fC(st.worstTrade)}â‚¬</div></div>`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid var(--border)"><div class="stat-label">ğŸ”¥ Max Streak</div><div class="stat-value" style="font-size:22px;color:var(--green)">${st.maxWinStreak}W</div><div class="stat-sub">Pire : ${st.maxLossStreak}L consÃ©cutifs</div></div>`;
  h+=`<div class="stat" style="background:var(--bg2);border:1px solid var(--border)"><div class="stat-label">ğŸ¯ Confiance moy.</div><div class="stat-value" style="font-size:22px;color:var(--amber)">${st.avgConf.toFixed(1)}<span style="font-size:13px;opacity:.5">/5</span></div><div class="stat-sub">High conf WR: ${st.highConfWR.toFixed(0)}%</div></div>`;
  h+=`</div>`;

  // Equity curve
  h+=`<div class="card anim-up d4"><h2>ğŸ“ˆ Equity Curve</h2><p class="card-desc">Ã‰volution de votre capital, trade par trade. Chaque point = un trade exÃ©cutÃ©. La pente dÃ©termine votre edge.</p><div class="chart-box"><canvas id="cEq"></canvas></div></div>`;

  // Row: Daily P&L + Market breakdown
  h+=`<div class="row2 anim-up d5"><div class="card"><h2>ğŸ“Š P&L Quotidien</h2><p class="card-desc">Performance nette par jour. L'objectif : plus de vert que de rouge, et un vert plus intense.</p><div class="chart-box sm"><canvas id="cDaily"></canvas></div></div>`;
  h+=`<div class="card"><h2>ğŸ¯ Performance par marchÃ©</h2><p class="card-desc">OÃ¹ gagnez-vous le plus ? Comparez vos wins/losses par type de marchÃ©.</p><div class="chart-box sm"><canvas id="cMk"></canvas></div></div></div>`;

  // Calendar with month picker
  const MOIS=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
  h+=`<div class="card anim-up d6"><h2>ğŸ—“ Calendrier P&L</h2><p class="card-desc">Heatmap quotidienne. Naviguez entre les mois pour voir votre historique. Survolez un jour pour les dÃ©tails.</p>`;
  h+=`<div class="month-nav"><button class="month-btn" onclick="calNav(-1)" title="Mois prÃ©cÃ©dent">â€¹</button><div class="month-label">${MOIS[S.calMonth]} ${S.calYear}</div><button class="month-btn" onclick="calNav(1)" title="Mois suivant">â€º</button><button class="month-btn today-btn" onclick="calToday()" title="Revenir au mois en cours">Aujourd'hui</button></div>`;
  // Month pills
  h+=`<div class="month-pills">`;
  for(let m=0;m<12;m++){
    const hasData=trades.some(t=>{const d=new Date(t.date+"T12:00:00");return d.getFullYear()===S.calYear&&d.getMonth()===m});
    h+=`<button class="month-pill ${m===S.calMonth?'active':''} ${hasData&&m!==S.calMonth?'has-data':''}" onclick="calSet(${S.calYear},${m})">${MOIS[m].slice(0,3)}</button>`;
  }
  h+=`</div>`;
  h+=renderCal(trades);
  // Month summary
  const monthTrades=trades.filter(t=>{const d=new Date(t.date+"T12:00:00");return d.getFullYear()===S.calYear&&d.getMonth()===S.calMonth});
  if(monthTrades.length){
    const mst=getStats(monthTrades);
    h+=`<div class="month-summary"><span style="color:var(--text2)">ğŸ“… ${MOIS[S.calMonth]}:</span><span style="color:${mst.netPnl>=0?'var(--green)':'var(--red)'};font-weight:800">${fC(mst.netPnl)}â‚¬</span><span style="color:var(--text3)">${monthTrades.length} trades</span><span style="color:var(--text3)">WR ${mst.winRate.toFixed(0)}%</span><span style="color:var(--text3)">PF ${mst.profitFactor>=999?'âˆ':mst.profitFactor.toFixed(2)}</span></div>`;
  } else {
    h+=`<div class="month-summary"><span style="color:var(--text3)">Aucun trade en ${MOIS[S.calMonth]} ${S.calYear}</span></div>`;
  }
  h+=`</div>`;

  // Distribution
  h+=`<div class="card anim-up d7"><h2>ğŸ“ Distribution des P&L</h2><p class="card-desc">RÃ©partition de vos rÃ©sultats. Un histogramme centrÃ© Ã  droite du zÃ©ro = edge positif.</p><div class="chart-box sm"><canvas id="cDist"></canvas></div></div>`;

  return h;
}

function renderFilters(){
  let h=`<div class="filters anim-up d1"><span style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1.4px;text-transform:uppercase;margin-right:8px">MarchÃ©</span>`;
  h+=`<button class="fbtn" onclick="sf('all')" style="background:${S.filter==='all'?'var(--green)':'var(--bg3)'};color:${S.filter==='all'?'var(--bg)':'var(--text2)'};border-color:${S.filter==='all'?'var(--green)':'var(--border)'}">Tous</button>`;
  Object.entries(MK).forEach(([k,m])=>{h+=`<button class="fbtn" onclick="sf('${k}')" style="background:${S.filter===k?m.color:'var(--bg3)'};color:${S.filter===k?'var(--bg)':'var(--text2)'};border-color:${S.filter===k?m.color:'var(--border)'}">${m.icon} ${m.label}</button>`});
  return h+`</div>`;
}

function renderCal(trades){
  const year=S.calYear,month=S.calMonth;
  const daily=getDailyPnl(trades);const map={};daily.forEach(d=>map[d.date]=d);
  const firstDay=new Date(year,month,1).getDay();const offset=(firstDay+6)%7;
  const daysInMonth=new Date(year,month+1,0).getDate();
  const today=ti();
  // filter daily to this month for intensity calc
  const monthDaily=daily.filter(d=>{const dt=new Date(d.date+"T12:00:00");return dt.getFullYear()===year&&dt.getMonth()===month});
  const maxAbs=monthDaily.length?Math.max(...monthDaily.map(d=>Math.abs(d.net)),1):1;
  let h=`<div class="cal-grid" style="margin-top:12px">`;
  ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(d=>h+=`<div class="cal-header">${d}</div>`);
  for(let i=0;i<offset;i++)h+=`<div class="cal-day"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const data=map[ds];const isToday=ds===today;
    let bg="var(--bg3)",pnl="",cnt="",todayBorder="";
    if(isToday)todayBorder="box-shadow:inset 0 0 0 2px var(--cyan);";
    if(data){
      const int=Math.min(Math.abs(data.net)/maxAbs,1);
      const alpha=Math.round(12+int*50).toString(16).padStart(2,'0');
      bg=data.net>=0?`#00e29a${alpha}`:`#ff4466${alpha}`;
      pnl=`<span class="day-pnl" style="color:${data.net>=0?'var(--green)':'var(--red)'}">${data.net>=0?'+':''}${data.net.toFixed(0)}</span>`;
      cnt=`<span class="day-count">${data.count}t</span>`;
    }
    h+=`<div class="cal-day tip" data-tip="${ds}${isToday?' (aujourd hui)':''}${data?` Â· ${data.count} trades Â· ${fC(data.net)}â‚¬`:''}" style="background:${bg};${todayBorder}"><span class="day-num">${d}</span>${pnl}${cnt}</div>`;
  }
  return h+`</div>`;
}

function calNav(dir){
  S.calMonth+=dir;
  if(S.calMonth>11){S.calMonth=0;S.calYear++}
  if(S.calMonth<0){S.calMonth=11;S.calYear--}
  R();
}
function calSet(y,m){S.calYear=y;S.calMonth=m;R()}
function calToday(){const now=new Date();S.calYear=now.getFullYear();S.calMonth=now.getMonth();R()}

function initCharts(){
  const trades=ft();if(!trades.length)return;
  const sorted=[...trades].sort((a,b)=>a.date.localeCompare(b.date)||a.id-b.id);

  // Equity
  const eqEl=document.getElementById("cEq");
  if(eqEl){
    let cum=S.capital;const pts=[cum];
    sorted.forEach(t=>{cum+=t.pnl-(t.fees||0);pts.push(+cum.toFixed(2))});
    const gradient=eqEl.getContext('2d');
    const g=gradient.createLinearGradient(0,0,0,280);
    g.addColorStop(0,'#00e29a25');g.addColorStop(1,'#00e29a02');
    CH.eq=new Chart(eqEl,{type:'line',data:{labels:pts.map((_,i)=>i===0?'Start':'#'+i),datasets:[{label:'Capital â‚¬',data:pts,borderColor:'#00e29a',backgroundColor:g,fill:true,tension:.35,pointRadius:2.5,pointHoverRadius:6,pointBackgroundColor:'#00e29a',pointHoverBackgroundColor:'#fff',borderWidth:2.5}]},options:{...JSON.parse(JSON.stringify(CO)),scales:{...CO.scales,y:{...CO.scales.y,ticks:{...CO.scales.y.ticks,callback:v=>'â‚¬'+v.toLocaleString()}}}}});
  }

  // Daily P&L
  const daily=getDailyPnl(trades);
  const dpEl=document.getElementById("cDaily");
  if(dpEl){
    CH.dp=new Chart(dpEl,{type:'bar',data:{labels:daily.map(d=>fd(d.date)),datasets:[{label:'P&L net â‚¬',data:daily.map(d=>+d.net.toFixed(2)),backgroundColor:daily.map(d=>d.net>=0?'#00e29aaa':'#ff4466aa'),borderRadius:8,maxBarThickness:30,hoverBackgroundColor:daily.map(d=>d.net>=0?'#00e29a':'#ff4466')}]},options:{...JSON.parse(JSON.stringify(CO)),plugins:{...CO.plugins,legend:{display:false}}}});
  }

  // Market
  const mkEl=document.getElementById("cMk");
  if(mkEl){
    const mkd=Object.entries(MK).map(([k,m])=>{const mt=trades.filter(t=>t.market===k);return{label:m.label,color:m.color,wins:mt.filter(t=>t.pnl>0).length,losses:mt.filter(t=>t.pnl<=0).length,total:mt.length}}).filter(d=>d.total>0);
    CH.mk=new Chart(mkEl,{type:'bar',data:{labels:mkd.map(d=>d.label),datasets:[{label:'Wins',data:mkd.map(d=>d.wins),backgroundColor:'#00e29aaa',borderRadius:8,maxBarThickness:28},{label:'Losses',data:mkd.map(d=>d.losses),backgroundColor:'#ff4466aa',borderRadius:8,maxBarThickness:28}]},options:{...JSON.parse(JSON.stringify(CO)),scales:{...CO.scales,x:{...CO.scales.x,stacked:true},y:{...CO.scales.y,stacked:true}}}});
  }

  // Distribution
  const distEl=document.getElementById("cDist");
  if(distEl){
    const pnls=trades.map(t=>t.pnl);
    const mn=Math.floor(Math.min(...pnls)/50)*50,mx=Math.ceil(Math.max(...pnls)/50)*50;
    const bk=[];for(let i=mn;i<mx;i+=50)bk.push({min:i,max:i+50,count:0});
    pnls.forEach(p=>{const b=bk.find(b=>p>=b.min&&p<b.max);if(b)b.count++});
    CH.dist=new Chart(distEl,{type:'bar',data:{labels:bk.map(b=>`${b.min}`),datasets:[{data:bk.map(b=>b.count),backgroundColor:bk.map(b=>b.min>=0?'#00e29a80':'#ff446680'),hoverBackgroundColor:bk.map(b=>b.min>=0?'#00e29a':'#ff4466'),borderRadius:5,maxBarThickness:22}]},options:{...JSON.parse(JSON.stringify(CO)),plugins:{...CO.plugins,legend:{display:false}},scales:{...CO.scales,x:{...CO.scales.x,title:{display:true,text:'P&L â‚¬',color:'#4a5672',font:{size:10,family:"'JetBrains Mono'"}}},y:{...CO.scales.y,title:{display:true,text:'Trades',color:'#4a5672',font:{size:10,family:"'JetBrains Mono'"}}}}}});
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGGER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rLog(){
  const f=S.f,isEdit=S.editId!==null,pairs=PAIRS[f.market]||[];

  // Today banner
  const today=ti(),todayT=S.trades.filter(t=>t.date===today);
  let h='';
  if(todayT.length){
    const ts=getStats(todayT);
    h+=`<div class="today-banner anim-right d1"><div class="tb-left"><div class="tb-dot"></div><div><div style="font-size:13px;font-weight:700">Aujourd'hui</div><div style="font-size:11px;color:var(--text2);font-family:var(--mono)">${todayT.length} trade${todayT.length>1?'s':''} Â· WR ${ts.winRate.toFixed(0)}%</div></div></div><div style="font-family:var(--mono);font-size:20px;font-weight:800;color:${ts.netPnl>=0?'var(--green)':'var(--red)'}">${fC(ts.netPnl)}â‚¬</div></div>`;
  }

  h+=`<div class="card anim-up d2 ${isEdit?'card-glow':''}"><h2>${isEdit?'âœï¸ Modifier trade #'+S.editId:'âœï¸ Nouveau trade'}</h2><p class="card-desc">${isEdit?'Modifiez les champs puis sauvegardez.':'Loggez votre trade. Le P&L est le champ le plus important â€” le reste enrichit vos analyses.'}</p>`;

  h+=`<div class="form-grid">`;
  h+=fg("Date","date","date",f.date);
  h+=`<div class="form-group"><label>MarchÃ©</label><select onchange="uf('market',this.value);uf('pair',PAIRS[this.value][0]);R()">`;
  Object.entries(MK).forEach(([k,m])=>h+=`<option value="${k}" ${f.market===k?'selected':''}>${m.icon} ${m.label}</option>`);
  h+=`</select></div>`;
  h+=`<div class="form-group"><label>Paire / Actif</label><select onchange="uf('pair',this.value)">${pairs.map(p=>`<option ${f.pair===p?'selected':''}>${p}</option>`).join('')}</select></div>`;
  h+=`<div class="form-group"><label>Direction</label><select onchange="uf('direction',this.value)"><option value="long" ${f.direction==='long'?'selected':''}>â–² Long</option><option value="short" ${f.direction==='short'?'selected':''}>â–¼ Short</option></select></div>`;
  h+=fg("Prix entrÃ©e","entry","text",f.entry,"0.00");
  h+=fg("Prix sortie","exit","text",f.exit,"0.00");
  h+=fg("Taille position","size","text",f.size,"ex: 0.05");
  const pnlVal=f.pnl?parseFloat(String(f.pnl).replace(",",".")):null;
  h+=`<div class="form-group"><label>P&L (â‚¬) *</label><input type="text" inputmode="decimal" placeholder="ex: 77.50" value="${f.pnl}" oninput="uf('pnl',this.value)" style="border-color:${pnlVal>0?'var(--green-mid)':pnlVal<0?'var(--red-mid)':'var(--border)'};background:${pnlVal>0?'var(--green-dim)':pnlVal<0?'var(--red-lo)':'var(--bg)'}"></div>`;
  h+=fg("Frais (â‚¬)","fees","text",f.fees,"0.00");
  h+=`<div class="form-group"><label>Tags</label><input type="text" placeholder="trend, scalp, macroâ€¦" value="${f.tags}" oninput="uf('tags',this.value)"></div>`;
  h+=`</div>`;

  // Confidence
  h+=`<div style="display:flex;align-items:center;gap:16px;margin-bottom:18px;flex-wrap:wrap"><div class="form-group" style="margin:0"><label>Confiance du setup</label><div class="conf-dots" style="margin-top:4px">`;
  for(let i=1;i<=5;i++){h+=`<div class="conf-dot ${f.confidence>=i?'active':''}" onclick="uf('confidence',${i});R()" data-tip="${['TrÃ¨s faible','Faible','Moyen','Fort','Setup A+'][i-1]}" style="width:${10+i*2}px;height:${10+i*2}px"></div>`}
  h+=`</div></div><span style="font-size:11px;color:var(--amber);font-weight:600;font-family:var(--mono)">${['â€”','âš ï¸ TrÃ¨s faible','ğŸ¤” Faible','ğŸ‘Œ Moyen','ğŸ’ª Fort','ğŸ”¥ Setup A+'][f.confidence||0]}</span></div>`;

  h+=`<div class="form-group" style="margin-bottom:18px"><label>Notes / Analyse</label><textarea placeholder="DÃ©crivez votre setup, votre Ã©tat d'esprit, ce qui a marchÃ© ou pasâ€¦" oninput="uf('notes',this.value)">${f.notes}</textarea></div>`;

  h+=`<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">`;
  h+=`<button class="btn btn-primary" onclick="saveTrade()">ğŸ’¾ ${isEdit?'Mettre Ã  jour':'Sauvegarder le trade'}</button>`;
  if(isEdit)h+=`<button class="btn btn-secondary" onclick="cancelEdit()">Annuler</button>`;
  h+=`<span id="ss" style="font-size:12px;font-weight:700"></span></div></div>`;

  return h;
}

function fg(label,key,type,value,placeholder){
  return`<div class="form-group"><label>${label}</label><input type="${type}" ${type==='text'?'inputmode="decimal"':''} placeholder="${placeholder||''}" value="${value}" oninput="uf('${key}',this.value)"></div>`}
function uf(k,v){S.f[k]=v}

function saveTrade(){
  const f=S.f,pnl=parseFloat(String(f.pnl).replace(",","."));
  if(isNaN(pnl)){showS("âŒ Le P&L est requis","var(--red)");return}
  const trade={id:S.editId||S.nextId,date:f.date,market:f.market,pair:f.pair,direction:f.direction,entry:parseFloat(String(f.entry).replace(",","."))||0,exit:parseFloat(String(f.exit).replace(",","."))||0,size:parseFloat(String(f.size).replace(",","."))||0,pnl,fees:parseFloat(String(f.fees).replace(",","."))||0,confidence:f.confidence||3,notes:f.notes,tags:typeof f.tags==='string'?f.tags.split(",").map(t=>t.trim()).filter(Boolean):f.tags||[]};
  if(S.editId){S.trades=S.trades.map(t=>t.id===S.editId?trade:t);S.editId=null}
  else{S.trades.push(trade);S.nextId++}
  persist();resetForm();showS("âœ“ Trade sauvegardÃ©","var(--green)");R();
}
function resetForm(){S.f={date:ti(),market:"crypto",pair:"BTC/USDT",direction:"long",entry:"",exit:"",size:"",pnl:"",fees:"",confidence:3,notes:"",tags:""};S.editId=null}
function cancelEdit(){resetForm();R()}
function editTrade(id){
  const t=S.trades.find(t=>t.id===id);if(!t)return;
  S.editId=id;S.f={date:t.date,market:t.market,pair:t.pair,direction:t.direction,entry:String(t.entry),exit:String(t.exit),size:String(t.size),pnl:String(t.pnl),fees:String(t.fees||""),confidence:t.confidence||3,notes:t.notes||"",tags:Array.isArray(t.tags)?t.tags.join(", "):t.tags||""};
  S.view="log";R();
}
function showS(t,c){const el=document.getElementById("ss");if(el){el.textContent=t;el.style.color=c;setTimeout(()=>{if(el)el.textContent=""},2500)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rHist(){
  const trades=ft();
  let h=renderFilters();
  if(!trades.length)return h+`<div class="empty anim-scale"><div class="empty-icon">ğŸ“‹</div><p>Aucun trade trouvÃ©.</p></div>`;
  const sorted=[...trades].sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const grouped={};sorted.forEach(t=>{if(!grouped[t.date])grouped[t.date]=[];grouped[t.date].push(t)});
  let di=0;
  Object.entries(grouped).forEach(([date,tr])=>{
    di++;const dayPnl=tr.reduce((s,t)=>s+t.pnl-(t.fees||0),0);
    h+=`<div class="card anim-up d${Math.min(di,8)}"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px"><h2 style="margin:0">${fdl(date)}</h2><div style="display:flex;gap:14px;align-items:center;font-family:var(--mono);font-size:12px"><span style="color:var(--text2)">${tr.length} trade${tr.length>1?'s':''}</span><span style="color:${dayPnl>=0?'var(--green)':'var(--red)'};font-weight:800;font-size:14px">${fC(dayPnl)}â‚¬</span></div></div>`;
    h+=`<div style="overflow-x:auto"><table class="trade-table"><thead><tr><th>Paire</th><th>Dir.</th><th>EntrÃ©e</th><th>Sortie</th><th>Taille</th><th>P&L</th><th>Conf.</th><th>Notes</th><th></th></tr></thead><tbody>`;
    tr.forEach(t=>{
      const mk=MK[t.market]||{};
      h+=`<tr><td><span class="tag ${mk.tag||''}">${mk.icon||''} ${t.pair}</span></td>`;
      h+=`<td class="dir-${t.direction}">${t.direction==='long'?'â–² Long':'â–¼ Short'}</td>`;
      h+=`<td>${t.entry||'â€”'}</td><td>${t.exit||'â€”'}</td><td>${t.size||'â€”'}</td>`;
      h+=`<td class="${t.pnl>=0?'pnl-pos':'pnl-neg'}">${fC(t.pnl)}â‚¬</td>`;
      h+=`<td>${'â—'.repeat(t.confidence||0)+'â—‹'.repeat(5-(t.confidence||0))}</td>`;
      h+=`<td style="font-family:var(--font);font-size:11px;color:var(--text2);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(t.notes||'').replace(/"/g,'&quot;')}">${t.notes||'â€”'}</td>`;
      h+=`<td style="white-space:nowrap">`;
      if(S.deleteId===t.id){h+=`<button class="btn btn-danger" style="padding:4px 10px;font-size:10px" onclick="event.stopPropagation();delTrade(${t.id})">Suppr</button> <button class="btn btn-secondary" style="padding:4px 10px;font-size:10px" onclick="event.stopPropagation();S.deleteId=null;R()">Ã—</button>`}
      else{h+=`<button style="background:none;border:none;cursor:pointer;font-size:13px;padding:4px;transition:transform .15s" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'" onclick="editTrade(${t.id})" title="Modifier">âœï¸</button><button style="background:none;border:none;cursor:pointer;font-size:13px;padding:4px;transition:transform .15s" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'" onclick="event.stopPropagation();S.deleteId=${t.id};R()" title="Supprimer">ğŸ—‘</button>`}
      h+=`</td></tr>`;
    });
    h+=`</tbody></table></div></div>`;
  });
  h+=`<div class="anim-fade d8" style="text-align:center;padding:16px 0;color:var(--text3);font-size:11px">${trades.length} trade${trades.length>1?'s':''} Â· <span style="color:var(--green);font-weight:700">Stay disciplined ğŸ¯</span></div>`;
  return h;
}
function delTrade(id){S.trades=S.trades.filter(t=>t.id!==id);S.deleteId=null;persist();R()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSIGHTS (new tab)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rInsights(){
  const trades=S.trades,st=getStats(trades);
  if(trades.length<3)return`<div class="empty anim-scale"><div class="empty-icon">ğŸ§ </div><p>Minimum 3 trades nÃ©cessaires pour les insights.</p></div>`;

  let h=`<div class="card anim-right d1"><h2>ğŸ§  Insights & Analyses</h2><p class="card-desc">Analyses automatiques de votre trading. Ces donnÃ©es vous aident Ã  identifier vos forces, faiblesses et axes d'amÃ©lioration.</p></div>`;

  // Badges
  h+=`<div class="card anim-up d2"><h2>ğŸ… Badges de performance</h2><p class="card-desc">DÃ©bloquez des badges en atteignant certains jalons. Continuez Ã  trader pour en obtenir plus.</p><div class="badges">`;
  const badges=[
    {icon:"ğŸ¯",label:"Sniper",desc:"Win Rate > 60%",earned:st.winRate>60},
    {icon:"ğŸ”¥",label:"On Fire",desc:"3+ wins consÃ©cutifs",earned:st.maxWinStreak>=3},
    {icon:"ğŸ’",label:"Diamond Hands",desc:"10+ trades",earned:st.total>=10},
    {icon:"ğŸ¦",label:"Profitable",desc:"P&L net positif",earned:st.netPnl>0},
    {icon:"âš¡",label:"Scalper",desc:"15+ trades",earned:st.total>=15},
    {icon:"ğŸ›¡",label:"Risk Manager",desc:"Profit Factor > 1.5",earned:st.profitFactor>1.5},
    {icon:"ğŸ§Š",label:"Ice Cold",desc:"Perte max < 150â‚¬",earned:Math.abs(st.worstTrade)<150},
    {icon:"ğŸ‘‘",label:"King Trade",desc:"Un trade > 300â‚¬",earned:st.bestTrade>300},
  ];
  badges.forEach(b=>{h+=`<div class="badge ${b.earned?'earned':''}" title="${b.desc}"><span class="badge-icon">${b.icon}</span><div><div style="font-weight:700">${b.label}</div><div style="font-size:9px;color:var(--text3)">${b.desc}</div></div></div>`});
  h+=`</div></div>`;

  // Best pair
  const pairMap={};trades.forEach(t=>{if(!pairMap[t.pair])pairMap[t.pair]={pnl:0,count:0,wins:0};pairMap[t.pair].pnl+=t.pnl;pairMap[t.pair].count++;if(t.pnl>0)pairMap[t.pair].wins++});
  const pairsSorted=Object.entries(pairMap).sort((a,b)=>b[1].pnl-a[1].pnl);

  h+=`<div class="row2 anim-up d3">`;
  h+=`<div class="card"><h2>ğŸ’° Top paires (P&L)</h2><p class="card-desc">Classement de vos paires par P&L cumulÃ©.</p>`;
  pairsSorted.forEach(([pair,data],i)=>{
    const pct=data.count?(data.wins/data.count*100):0;
    h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;${i<pairsSorted.length-1?'border-bottom:1px solid var(--border)':''}"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:12px;color:var(--text3);font-family:var(--mono);width:20px">#${i+1}</span><span style="font-size:13px;font-weight:600">${pair}</span><span style="font-size:10px;color:var(--text3)">${data.count}t Â· WR ${pct.toFixed(0)}%</span></div><span style="font-family:var(--mono);font-weight:800;font-size:13px;color:${data.pnl>=0?'var(--green)':'var(--red)'}">${fC(data.pnl)}â‚¬</span></div>`;
  });
  h+=`</div>`;

  // Direction analysis
  const longs=trades.filter(t=>t.direction==='long'),shorts=trades.filter(t=>t.direction==='short');
  const lstats=getStats(longs),sstats=getStats(shorts);
  h+=`<div class="card"><h2>ğŸ“ Long vs Short</h2><p class="card-desc">Comparaison de vos performances par direction.</p>`;
  h+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;font-family:var(--mono);font-size:12px">`;
  h+=`<div style="padding:14px;border-radius:var(--radius-sm);background:var(--green-dim);border:1px solid var(--green-mid)"><div style="font-size:10px;color:var(--text3);margin-bottom:6px;font-weight:700">â–² LONG</div><div style="font-size:20px;font-weight:800;color:var(--green)">${fC(lstats.netPnl)}â‚¬</div><div style="margin-top:6px;color:var(--text2)">${longs.length}t Â· WR ${lstats.winRate.toFixed(0)}%</div></div>`;
  h+=`<div style="padding:14px;border-radius:var(--radius-sm);background:var(--red-lo);border:1px solid var(--red-mid)"><div style="font-size:10px;color:var(--text3);margin-bottom:6px;font-weight:700">â–¼ SHORT</div><div style="font-size:20px;font-weight:800;color:var(--red)">${fC(sstats.netPnl)}â‚¬</div><div style="margin-top:6px;color:var(--text2)">${shorts.length}t Â· WR ${sstats.winRate.toFixed(0)}%</div></div>`;
  h+=`</div></div></div>`;

  // Confidence analysis
  h+=`<div class="card anim-up d4"><h2>ğŸ¯ Analyse par confiance</h2><p class="card-desc">Vos rÃ©sultats selon le niveau de confiance que vous aviez avant d'entrer. Tradez-vous mieux quand vous Ãªtes sÃ»r de vous ?</p>`;
  h+=`<div style="display:flex;gap:10px;flex-wrap:wrap">`;
  for(let c=1;c<=5;c++){
    const ct=trades.filter(t=>(t.confidence||3)===c);if(!ct.length)continue;
    const cst=getStats(ct);
    h+=`<div style="flex:1;min-width:100px;padding:14px;border-radius:var(--radius-sm);background:var(--bg3);border:1px solid var(--border);text-align:center"><div style="font-size:16px;margin-bottom:4px">${'â˜…'.repeat(c)+'â˜†'.repeat(5-c)}</div><div style="font-family:var(--mono);font-size:16px;font-weight:800;color:${cst.netPnl>=0?'var(--green)':'var(--red)'}">${fC(cst.netPnl)}â‚¬</div><div style="font-size:10px;color:var(--text3);margin-top:4px">${ct.length}t Â· WR ${cst.winRate.toFixed(0)}%</div></div>`;
  }
  h+=`</div></div>`;

  // Quick tips
  h+=`<div class="card anim-left d5" style="border-color:var(--amber);border-style:dashed"><h2>ğŸ’¡ Tips auto-gÃ©nÃ©rÃ©s</h2><div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;font-size:12px;color:var(--text2);line-height:1.6">`;
  if(st.highConfWR>st.winRate+5)h+=`<div>ğŸ¯ <strong style="color:var(--green)">Bonne nouvelle :</strong> Vos trades Ã  haute confiance (â‰¥4/5) ont un WR de ${st.highConfWR.toFixed(0)}% vs ${st.winRate.toFixed(0)}% global. <em>Soyez plus sÃ©lectif.</em></div>`;
  if(st.avgLoss>st.avgWin)h+=`<div>âš ï¸ <strong style="color:var(--amber)">Attention :</strong> Votre perte moyenne (${st.avgLoss.toFixed(0)}â‚¬) dÃ©passe votre gain moyen (${st.avgWin.toFixed(0)}â‚¬). Resserrez vos stop-loss ou laissez courir vos gains.</div>`;
  if(lstats.winRate>sstats.winRate+15&&shorts.length>=3)h+=`<div>ğŸ“ <strong style="color:var(--cyan)">Direction :</strong> Vous Ãªtes nettement meilleur en Long (${lstats.winRate.toFixed(0)}% WR) qu'en Short (${sstats.winRate.toFixed(0)}%). Concentrez-vous sur les setups haussiers.</div>`;
  if(st.maxLossStreak>=3)h+=`<div>â„ï¸ <strong style="color:var(--red)">Discipline :</strong> Vous avez eu une sÃ©rie de ${st.maxLossStreak} pertes consÃ©cutives. AprÃ¨s 2 pertes de suite, faites une pause.</div>`;
  if(st.profitFactor>1.5)h+=`<div>ğŸ¦ <strong style="color:var(--green)">Solide :</strong> Profit Factor de ${st.profitFactor.toFixed(2)} â€” votre edge est rÃ©el. Continuez avec la mÃªme discipline.</div>`;
  h+=`</div></div>`;

  return h;
}

/* â•â•â• INIT â€” auth listener calls R() after login â•â•â• */
</script>
</body>
</html>
